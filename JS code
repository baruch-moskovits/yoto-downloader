// First, find the script element by its ID
const scriptElement = document.getElementById('__NEXT_DATA__');

function convertSeconds(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const remainingSeconds = seconds % 60;

    return `${hours}h ${minutes}m ${remainingSeconds}s`;
}

function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// Check if the element exists
if (scriptElement) {
    // Parse the JSON content of the script element
    const jsonData = JSON.parse(scriptElement.textContent);

    // Navigate to the specific path where trackUrl, title, and icon16x16 are located
    const chapters = jsonData.props.pageProps.card.content.chapters;
    
    // Create a container for the links
    const container = document.createElement('div');
    container.style.margin = '20px';
    container.style.backgroundColor = '#deefff';
    container.style.padding = '20px';

    // Add a title to the container
    const containerTitle = document.createElement('h2');
    containerTitle.innerHTML += '<a href="https://github.com/baruch-moskovits/yoto-downloader">Downloader for Yoto</a>';
    container.appendChild(containerTitle);

    // Add an explanatory paragraph to the container
    const containerP = document.createElement('p');
    containerP.innerHTML += 'You can download the MP3 files and view the images directly from the links below. Use <a href="https://chromewebstore.google.com/detail/simple-mass-downloader/abdkkegmcbiomijcbdaodaflgehfffed">Simple Mass Downloader</a> to download all at once.';
    container.appendChild(containerP);
	
	 // Get the card art
    const card = jsonData.props.pageProps.card;
    const albumArtLink = document.createElement('a');
    albumArtLink.href = card.metadata.cover.imageL;
    albumArtLink.textContent = `${card.title} - cover`;
    albumArtLink.target = '_blank'; // Open in a new tab
    albumArtLink.style.display = 'block'; // Display link on a new line
    container.appendChild(albumArtLink); // Append the album art link to the container


	// Get the important details that may not be defined, fallback on an undefined data so it doesn't look blank
	var category = "tbd"
	if(card.metadata.category === ""){
		category = "undefined";
	}else{
		category = card.metadata.category;
	}
	var author = "tbd"
	if(card.metadata.author === ""){
		author = "undefined";
	}else{
		author = card.metadata.author;
	}
	var slug = "tbd"
	if(card.slug === ""){
		slug = "undefined";
	}else{
		slug = card.slug;
	}
	
    // Write metadata to a text file, use ":: " as the key::value pair delimiter for safer parsing down the road. We don't want to just drop the entire json blob into the file because it may contain personal data.
    const containermeta = document.createElement('textarea');    
    containermeta.innerHTML += `Basic Details\n================\n`;
    containermeta.innerHTML += `Title:: ${card.title}\n`;
	containermeta.innerHTML += `Author:: ${author}\n`; // only exsists for official cards
    containermeta.innerHTML += `Description:: ${card.metadata.description}\n`;
	containermeta.innerHTML += `\n`;
	
	containermeta.innerHTML += `Extended Details\n================\n`;
	containermeta.innerHTML += `Version:: ${card.content.version}\n`;
	containermeta.innerHTML += `Category:: ${category}\n`; // only exsists for official cards
   	containermeta.innerHTML += `Languages:: ${card.metadata.languages.toString()}\n`;	//This is an array, so it needs to be forced into a string.
    containermeta.innerHTML += `PlaybackType:: ${card.content.playbackType}\n`;
	containermeta.innerHTML += `CardID:: ${card.cardId}\n`;
    containermeta.innerHTML += `CreatedAt:: ${card.createdAt}\n`;
    containermeta.innerHTML += `UpdatedAt:: ${card.updatedAt}\n`;
	containermeta.innerHTML += `Slug:: ${slug}\n`;  // only exsists for official cards
	containermeta.innerHTML += `sortkey:: ${card.sortkey}\n`;	
	containermeta.innerHTML += `Duration:: ${card.metadata.media.duration}\n`;
	containermeta.innerHTML += `ReadableDuration:: ${convertSeconds(card.metadata.media.duration)}\n`; // not always available, so let's just calculate it to be easier
	containermeta.innerHTML += `FileSize:: ${card.metadata.media.fileSize}\n`;
	containermeta.innerHTML += `ReadableFileSize:: ${formatBytes(card.metadata.media.fileSize)}\n`; // not always available, so let's just calculate it to be easier
	containermeta.innerHTML += `Note:: ${card.metadata.note}\n`;
	containermeta.innerHTML += `\n`;
	    
	// These fields only exist in MYO cards
	containermeta.innerHTML += `\n`;
	containermeta.innerHTML += `Share Statistics\n================\n`;
	containermeta.innerHTML += `ShareCount:: ${card.shareCount}\n`;
    containermeta.innerHTML += `Availability:: ${card.availability}\n`;
    containermeta.innerHTML += `ShareLinkUrl:: ${card.shareLinkUrl}\n`;    
    containermeta.innerHTML += `\n`;
	
    containermeta.innerHTML += `Track Details\n================\n`;    
    // metadata continues after the tracks are looped to include track details

    // Initialize track and image numbers
    let trackNumber = 1;
    let imageNumber = 1;

    // Loop through chapters and tracks to create links
    chapters.forEach(chapter => {
        chapter.tracks.forEach(track => {
            // Create a link element for each track
            const trackLink = document.createElement('a');
            trackLink.href = track.trackUrl;

            // Pad the track number to 3 digits, Yoto cards can have up to 100 tracks
            trackLink.textContent = `${card.title} - ${String(trackNumber).padStart(3, 0)} - ${track.title}`; 
            trackLink.target = '_blank'; // Open in new tab
            trackLink.style.display = 'block'; // Display each link on a new line

            // Append the track link to the container
            container.appendChild(trackLink);

            // Add the track info into the metadata file
            containermeta.innerHTML += `TrackNumber:: ${String(trackNumber).padStart(3, 0)}\n`;
            containermeta.innerHTML += `Title:: ${track.title}\n`;
            containermeta.innerHTML += `Format:: ${track.format}\n`;
            containermeta.innerHTML += `Type:: ${track.type}\n`;
            containermeta.innerHTML += `Duration (Seconds):: ${track.duration}\n`;
            containermeta.innerHTML += `ReadableDuration:: ${convertSeconds(track.duration)}\n`; 
			containermeta.innerHTML += `FileSize:: ${track.fileSize}\n`;
            containermeta.innerHTML += `ReadableFileSize:: ${formatBytes(track.fileSize)}\n`;
			containermeta.innerHTML += `Channels:: ${track.channels}\n`;
            containermeta.innerHTML += `\n`;

            // Increment track number
            trackNumber++;

            // Create a link element for each image
            if (chapter.display && chapter.display.icon16x16) {
                const imageLink = document.createElement('a');
                imageLink.href = chapter.display.icon16x16;
                imageLink.textContent = `${card.title} - ${String(imageNumber).padStart(3, 0)} - ${track.title} (icon)`;
                imageLink.target = '_blank';
                imageLink.style.display = 'block';

                // Append the image link to the container
                container.appendChild(imageLink);

                // Increment image number
                imageNumber++;
            }
        });
    });

    // Finish the metadata builder
    container.appendChild(containermeta);
	// it would be good to put a button next to the textarea that copies the contents to clipboard if we can't set it to be downloadable.
	// i couldn't get this to work, its supposed to make the text content download as a txt file
    // var file = new Blob([containermeta.value], {type: 'text/plain'});
    // var cardMetadata = document.createElement('a');
    // cardMetadata.href = window.URL.createObjectURL(file.getBlob('text/plain'));
    // cardMetadata.download = `${card.title}.txt`;
    // cardMetadata.textContent = `${card.title} Metadata`;
    // container.appendChild(cardMetadata);
 
    // Insert the container at the top of the body of the page
    document.body.insertBefore(container, document.body.firstChild);
} else {
    console.error('Script element not found');
}
